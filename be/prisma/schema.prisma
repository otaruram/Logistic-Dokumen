// Prisma schema untuk Supply Chain OCR Multi-User System
generator client {
  provider             = "prisma-client-py"
  recursive_type_depth = 5
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Logs {
  id           Int      @id @default(autoincrement())
  userId       String   @default("anonymous@system.local") @map("user_id")
  timestamp    DateTime @default(now())
  filename     String
  kategori     String
  nomorDokumen String   @map("nomor_dokumen")
  receiver     String
  imagePath    String   @map("image_path")
  summary      String   @db.Text
  fullText     String   @map("full_text") @db.Text

  @@index([userId])
  @@map("logs")
}

model ApiKey {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id")
  apiKey    String   @map("api_key")
  provider  String   @default("openai") // "openai" for chatbot, "ocrspace" for OCR
  isActive  Boolean  @default(true) @map("is_active") // Toggle state: ON/OFF
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, provider]) // One API key per provider per user
  @@index([userId])
  @@map("api_keys")
}

model User {
  id            Int               @id @default(autoincrement())
  email         String            @unique
  name          String?
  creditBalance Int               @default(3) @map("credit_balance") // Daily credit limit: 3 credits
  tier          String            @default("starter") // starter, pro
  lastCreditReset DateTime?       @map("last_credit_reset") // Track last daily reset
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  
  // Relations
  transactions  CreditTransaction[]
  
  @@map("users")
}

model CreditTransaction {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  amount      Int      // Positive for credit, negative for debit
  description String
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("credit_transactions")
}
